{"version":3,"file":"static/webpack/static/development/pages/index.js.7047b8e131918d9d4334.hot-update.js","sources":["webpack:///./pages/index.js"],"sourcesContent":["import {useState, useCallback, useEffect} from 'react'\nimport {categoricalColorSchemes} from '@nivo/colors'\nimport fetch from 'isomorphic-unfetch'\nimport { scaleOrdinal } from 'd3-scale'\nimport { ResponsiveBar } from '@nivo/bar'\nimport 'iframe-resizer'\n\n\nconst surveyLabels = {\n    asked: {\n        legend: \"Au moins une prestation de la simulation a fait l'objet d'une demande réussie (c'est à dire que l'usager a été au bout de la démarche)\",\n        short: 'Demande réussie',\n        single: 'D. réussie'\n    },\n    failed: {\n        legend: \"Au moins une prestation de la simulation a fait l'objet d'une demande mais l'usager <b>N'A PAS</b> réussi à aller au bout de la démarche\",\n        short: 'Demande échouée',\n        single: 'D. échouée'\n    },\n    nothing: {\n        legend: \"Aucune prestation n'a fait l'objet d'une demande alors qu'elles ne sont pas perçues\",\n        short: 'Aucune demande',\n        single: 'Rien fait'\n    },\n    already: {\n        legend:\"Toutes les prestations affichées étaient déjà perçues\",\n        short: 'Déjà perçues',\n        single: 'Déjà perçue'\n    }\n}\n\nconst globalSurveyResults = [\n    { category: 'asked', value: 305 },\n    { category: 'failed', value: 110 },\n    { category: 'nothing', value: 133 },\n    { category: 'already', value: 22 },\n]\nconst surveyIds = Object.keys(surveyLabels)\n\nconst catMapping = {\n    show: { cat: 'Affiché' },\n\n    click: { cat: 'Cliqué' },\n    form: { cat: 'Actionné', name: 'Formulaire' },\n    instructions: { cat: 'Actionné', name: 'Instructions' },\n    link: { cat: 'Actionné', name: 'Lien' },\n    msa: { cat: 'Actionné', name: 'MSA' },\n    'show-locations': { cat: 'Actionné', name: 'Agence' },\n    teleservice: { cat: 'Actionné', name: 'Téléservice' },\n    'link-ineligible': { cat: 'Actionné inélig.', name: 'Lien sans éligibilité' },\n\n    'show-unexpected': { cat: 'Incompris'},\n\n    close: { cat: 'Expliqué', name: 'Fermé'},\n    'retour-logement':  {cat: 'Expliqué', name: 'Retour page logement'},\n    'simulation-caf':  {cat: 'Expliqué', name: 'Simulateur CAF'},\n    email: { cat: 'Expliqué', name: 'Email'},\n}\n\nconst cats = [\n    'Affiché',\n    'Cliqué',\n    'Actionné',\n    'Actionné inélig.',\n    'Incompris',\n    'Expliqué'\n]\nconst actionColors = scaleOrdinal(categoricalColorSchemes.category10)\nconst surveyColors = scaleOrdinal([\n    '#2ca02c',\n    '#ff7f0e',\n    '#d62728',\n    '#7f7f7f',\n]).domain(Object.keys(surveyLabels))\n\nfunction apply(prop, base, shouldShow) {\n    let result = base.subtable.reduce((accum, table) => {\n        if (!catMapping[table.label]) {\n            return accum\n        }\n        accum[catMapping[table.label].cat] = accum[catMapping[table.label].cat] || {\n            category: catMapping[table.label].cat\n        }\n        accum[catMapping[table.label].cat][table.label] = table[prop]\n        return accum\n    }, {})\n\n    Object.keys(shouldShow).forEach(k => {\n        if (!shouldShow[k]) {\n            delete result[k]\n        }\n    })\n\n    return Object.values(result)\n}\n\nconst sources = {\n//    nb_uniq_visitors: 'Visiteur unique', // Non fonctionnel avec les données mensuelles\n    nb_visits: 'Visite',\n    nb_events: 'Évènement'\n}\n\nconst periods = {\n    day: 'Hier',\n    month: 'Mois en cours'\n}\n\n// make sure parent container have a defined height when using\n// responsive component, otherwise height will be 0 and\n// no chart will be rendered.\n// website examples showcase many properties,\n// you'll often use just a few of them.\nconst ActionResponsiveBar = ({ data /* see data tab */ }) => (\n    <ResponsiveBar\n        data={data}\n        keys={Object.keys(catMapping)}\n        indexBy=\"category\"\n        margin={{ top: 15, right: 10, bottom: 50, left: 60 }}\n        padding={0.3}\n        colors={({ id }) => actionColors(id)}\n        borderColor={{ from: 'color', modifiers: [ [ 'darker', 1.6 ] ] }}\n        animate={false}\n    />\n)\n\nfunction Home() {\n    const [survey, setSurvey] = useState({\n        summary: [],\n        details: {\n            data:[],\n            maxPercentage: 100,\n        }\n    });\n    const [benefits, setBenefits] = useState([]);\n    const [showActions, setShowActions] = useState(true);\n    const [showSurveyDetails, setShowSurveyDetails] = useState(true);\n    const [openfiscaVariables, setOpenfiscaVariables] = useState({});\n    const [period, setPeriod] = useState('day');\n    const [source, setSource] = useState('nb_visits');\n    const [show, setShow] = useState(cats.reduce((accum, c) => {\n        accum[c] = true\n        return accum\n    }, {}))\n\n    async function fetchData(period) {\n        try {\n            const res = await fetch(`https://stats.data.gouv.fr/index.php?date=yesterday&expanded=1&filter_limit=50&format=JSON&idSite=9&method=Events.getName&module=API&period=${period}`)\n            const json = await res.json()\n            setBenefits(json)\n        } catch {\n            setBenefits([])\n        }\n    }\n\n    async function fetchSurveyData(period) {\n        try {\n            const res = await fetch('https://mes-aides.gouv.fr/documents/stats.json')\n            const json = await res.json()\n\n            const summary = surveyIds.map(id => {\n                return {\n                    key: id,\n                    category: surveyLabels[id].short,\n                    value: json.survey.summary[id]\n                }\n            })\n\n            const details = json.survey.details.map(d => {\n                const data =  surveyIds.map(id => {\n                    return {\n                        id: d.id,\n                        key: id,\n                        category: surveyLabels[id].single,\n                        value: d[id],\n                        percentage: Math.round(d[id]/d.total*1000)/10 || 0\n                    };\n                });\n\n                return {\n                    id: d.id,\n                    data: data,\n                    total: d.total\n                }\n            })\n            const maxPercentage = Math.min(100, 1.1 *Math.max(...details.map(d => d.total <= 10 ?  0 :  Math.max(...d.data.map(p => p.percentage )))))\n\n            let survey = {\n                summary,\n                details: {\n                    data: details,\n                    maxPercentage,\n                },\n                count: json.survey.summary.total\n            }\n            setSurvey(survey)\n        } catch {\n            setBenefits([])\n        }\n    }\n\n    async function fetchOpenfiscaVariables() {\n        try {\n            const res = await fetch('http://localhost:9000/api/benefits')\n            const json = await res.json()\n            setOpenfiscaVariables(json.reduce((a,v) => {\n                a[v.id] = v\n                return a\n            }, {}))\n        } catch {\n            setOpenfiscaVariables({})\n        }\n    }\n\n    useEffect(() => {\n      fetchData(period)\n      fetchSurveyData()\n      fetchOpenfiscaVariables()\n    }, [])\n\n    const handlePeriodChange = useCallback(e => {\n        setPeriod(e.target.value)\n        fetchData(e.target.value)\n    })\n    const handleSourceChange = useCallback(e => {\n        setSource(e.target.value)\n    })\n    const handleShowChange = useCallback((cat, value) => {\n        setShow({...show, [cat]: value})\n    })\n    return (\n        <div>\n        <style jsx>{`\n            div {\n                font-family: sans;\n            }\n\n            .chart {\n                height: 300px;\n            }\n            .list {\n                display: flex;\n                flex-wrap: wrap;\n            }\n\n            .doubleCell {\n                max-width: 600px;\n            }\n\n            .cell {\n                width: 345px;\n                display: flex;\n                flex-direction: column;\n                justify-content: space-between;\n            }\n            h3 {\n                margin: 0;\n            }\n\n            h4 small {\n                display: block;\n            }\n          `}</style>\n          <h1>Statistiques d'impact et d'aide à l'amélioration du produit Mes Aides</h1>\n\n          <h2>Résultats de sondage 7 jours après les simulations (sur {survey.summary.total} réponses)</h2>\n\n          <h3>Résumé du sondage</h3>\n            { survey.summary.map(v => (\n                <div key={v.key}><span style={{color:surveyColors(v.category)}}>◼</span>&nbsp;<span dangerouslySetInnerHTML={{ __html: surveyLabels[v.key].legend }}></span></div>\n            ))}\n          <div className=\"chart doubleCell\">\n          <ResponsiveBar\n            label={d => `${d.value} (${Math.round(100*d.value / survey.count)}%)` }\n            data={survey.summary}\n            indexBy=\"category\"\n            keys={[\"value\"]}\n            isInteractive={false}\n            margin={{ top: 15, right: 10, bottom: 50, left: 60 }}\n            padding={0.3}\n            colors={({data}) => surveyColors(data.category) }\n            borderColor={{ from: 'color', modifiers: [ [ 'darker', 1.6 ] ] }}\n            animate={false}\n        /></div>\n        <h3>Détails des résultats du sondage par prestation <button onClick={() => setShowSurveyDetails(!showSurveyDetails)}>Afficher/Cacher</button></h3>\n        { showSurveyDetails && (<div className=\"list\">\n            { survey.details.data.map(k => (\n                <div className=\"cell\" key={k.id}>\n                    <h4>\n                        {openfiscaVariables[k.id] && openfiscaVariables[k.id].label || k.id}\n                        <small>sur {k.total} réponses</small>\n                    </h4>\n                    <div className=\"chart\">\n                        <ResponsiveBar\n                            axisLeft={{\n                              format: value =>\n                                `${Number(value)} %`,\n                            }}\n                            label={d => d.data.value }\n                            data={k.data}\n                            maxValue={survey.details.maxPercentage}\n                            indexBy=\"category\"\n                            keys={[\"percentage\"]}\n                            isInteractive={false}\n                            margin={{ top: 15, right: 10, bottom: 50, left: 60 }}\n                            padding={0.3}\n                            colors={({data}) => surveyColors(data.category) }\n                            borderColor={{ from: 'color', modifiers: [ [ 'darker', 1.6 ] ] }}\n                            animate={false}\n                        />\n                    </div>\n                </div>\n            ))}\n        </div>)}\n\n\n                  <h2>Comportements utilisateur sur la page de résultats <button onClick={() => setShowActions(!showActions)}>Afficher/Cacher</button></h2>\n            { showActions && (<div>\n                <p>\n                    Les graphiques suivants représentent les taux de conversion sur la page de présentation de résultats sur le simulateur.\n                    Différents évènements sont capturés pour mieux évaluer l'impact du simulateur sur le non-recours aux dispositifs présentés aux usagers.\n                </p>\n                <div className=\"list\">\n                    <div className=\"cell\">\n                        <div><label>\n                            Période de référence\n                            <select onChange={handlePeriodChange} defaultValue={period}>\n                            {\n                                Object.keys(periods).map(k => {\n                                    return <option key={k} value={k}>{periods[k]}</option>\n                                })\n                            }\n                            </select>\n                        </label></div>\n                        <div><label>\n                            Source des données\n                            <select onChange={handleSourceChange} defaultValue={source}>\n                            {\n                                Object.keys(sources).map(k => {\n                                    return <option key={k} value={k}>{sources[k]}</option>\n                                })\n                            }\n                            </select>\n                        </label></div>\n                        <table>\n                        <tbody>\n                        {\n                            cats.map(cat => {\n                                return (\n                                    <tr key={cat}>\n                                        <td>\n                                            <label>{show[cat]}<input type=\"checkbox\" checked={show[cat]} onChange={e => handleShowChange(cat, e.target.checked)} />\n                                            {cat}</label>\n                                        </td>\n                                        <td>\n                                        {Object.keys(catMapping).map(catId => {\n                                            if (catMapping[catId].cat === cat) {\n                                                return <div key={catId}><span style={{color:actionColors(catId)}}>◼</span>&nbsp;{catMapping[catId].name || catMapping[catId].cat}</div>\n                                            }\n                                        })}\n                                        </td>\n                                    </tr>\n                                )\n                            })\n                        }\n                        </tbody>\n                        </table>\n                    </div>\n              {benefits.map(b => {\n                let l = b.label\n                let data = apply(source, b, show)\n\n                if (!data.length) {\n                    return\n                }\n\n                return (\n                    <div key={l} className=\"cell\">\n                        <h3>{l}</h3>\n                        <div className=\"chart\">\n                            <ActionResponsiveBar data={data} />\n                        </div>\n                    </div>\n                )\n              })}\n              </div>\n          </div>) }\n\n\n        </div>\n    );\n}\n\nexport default Home;\n"],"mappings":"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","sourceRoot":""}